// RealRiches Prisma Schema
// Comprehensive NYC rental platform database schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis, pgvector(map: "vector")]
}

// ====================
// ENUMS
// ====================

enum UserRole {
  TENANT
  LANDLORD
  AGENT
  INVESTOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum SubscriptionTier {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum ListingType {
  RENTAL
  SALE
  RENTAL_OR_SALE
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  RENTED
  SOLD
  ARCHIVED
  EXPIRED
}

enum PropertyType {
  STUDIO
  ONE_BEDROOM
  TWO_BEDROOM
  THREE_BEDROOM
  FOUR_PLUS_BEDROOM
  TOWNHOUSE
  PENTHOUSE
  LOFT
  DUPLEX
  HOUSE
  MULTI_FAMILY
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  SCREENING
  CONDITIONAL_OFFER
  APPROVED
  DENIED
  WITHDRAWN
  LEASE_SENT
  LEASE_SIGNED
}

enum LeaseStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
  RENEWED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentType {
  RENT
  SECURITY_DEPOSIT
  BROKER_FEE
  APPLICATION_FEE
  LATE_FEE
  UTILITY
  MAINTENANCE
  OTHER
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
  IMESSAGE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  SHOWING_SCHEDULED
  APPLICATION_STARTED
  CONVERTED
  LOST
}

enum TourStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ====================
// USER & AUTH
// ====================

model User {
  id                    String            @id @default(cuid())
  email                 String            @unique
  passwordHash          String
  role                  UserRole          @default(TENANT)
  status                UserStatus        @default(PENDING_VERIFICATION)
  firstName             String
  lastName              String
  phone                 String?           @unique
  dateOfBirth           DateTime?
  avatarUrl             String?
  timezone              String            @default("America/New_York")
  
  // Verification
  emailVerified         Boolean           @default(false)
  emailVerifiedAt       DateTime?
  phoneVerified         Boolean           @default(false)
  phoneVerifiedAt       DateTime?
  
  // Agent-specific
  licenseNumber         String?
  licenseState          String?
  licenseExpiry         DateTime?
  brokerageName         String?
  brokerageAddress      String?
  
  // Investor-specific
  investmentPreferences Json?
  accreditedInvestor    Boolean?
  
  // Subscription
  subscriptionTier      SubscriptionTier  @default(FREE)
  subscriptionExpiresAt DateTime?
  
  // Metadata
  lastLoginAt           DateTime?
  loginCount            Int               @default(0)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  deletedAt             DateTime?
  
  // Relations
  sessions              Session[]
  ownedListings         Listing[]         @relation("OwnerListings")
  agentListings         Listing[]         @relation("AgentListings")
  applications          Application[]     @relation("ApplicantApplications")
  tenantLeases          Lease[]           @relation("TenantLeases")
  landlordLeases        Lease[]           @relation("LandlordLeases")
  agentLeases           Lease[]           @relation("AgentLeases")
  payments              Payment[]
  notifications         Notification[]
  leads                 Lead[]            @relation("AgentLeads")
  tours                 Tour[]            @relation("AgentTours")
  feedbackReceived      AgentFeedback[]   @relation("AgentFeedback")
  feedbackGiven         AgentFeedback[]   @relation("FeedbackProvider")

  @@index([email])
  @@index([role, status])
  @@index([deletedAt])
}

model Session {
  id            String    @id @default(cuid())
  userId        String
  refreshToken  String    @unique
  userAgent     String?
  ipAddress     String?
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  revokedAt     DateTime?
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
}

// ====================
// LISTINGS
// ====================

model Listing {
  id                  String          @id @default(cuid())
  ownerId             String
  agentId             String?
  
  type                ListingType
  status              ListingStatus   @default(DRAFT)
  propertyType        PropertyType
  
  title               String
  description         String
  
  // Address
  address             String
  unit                String?
  city                String
  state               String
  zipCode             String
  neighborhood        String?
  borough             String?
  latitude            Float?
  longitude           Float?
  
  // Property details
  bedrooms            Int
  bathrooms           Decimal         @db.Decimal(3, 1)
  squareFeet          Int?
  floor               Int?
  totalFloors         Int?
  yearBuilt           Int?
  
  // Pricing - FARE Act compliant
  rentPrice           Decimal?        @db.Decimal(10, 2)
  salePrice           Decimal?        @db.Decimal(12, 2)
  securityDeposit     Decimal?        @db.Decimal(10, 2)
  brokerFee           Decimal?        @db.Decimal(10, 2)
  brokerFeePercent    Decimal?        @db.Decimal(4, 2)
  applicationFee      Decimal?        @db.Decimal(6, 2) @default(20)
  moveInCosts         Json?
  
  // FARE Act compliance
  fareActCompliant    Boolean         @default(false)
  fareActDisclosures  Json?
  
  // Lease terms
  availableDate       DateTime?
  leaseTermMonths     Int?            @default(12)
  
  // Features
  amenities           String[]
  utilitiesIncluded   String[]
  petPolicy           String?
  
  // Media
  photos              Json[]
  virtualTourUrl      String?
  floorPlanUrl        String?
  videoUrl            String?
  
  // AI enhancements
  aiDescription       String?
  aiHighlights        String[]
  aiNeighborhoodScore Json?
  hiddenGemScore      Int?
  
  // Analytics
  viewCount           Int             @default(0)
  inquiryCount        Int             @default(0)
  applicationCount    Int             @default(0)
  
  // Metadata
  publishedAt         DateTime?
  expiresAt           DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  deletedAt           DateTime?
  
  // Relations
  owner               User            @relation("OwnerListings", fields: [ownerId], references: [id])
  agent               User?           @relation("AgentListings", fields: [agentId], references: [id])
  applications        Application[]
  leases              Lease[]
  leads               Lead[]
  tours               Tour[]

  @@index([ownerId])
  @@index([agentId])
  @@index([status, type])
  @@index([city, borough, neighborhood])
  @@index([rentPrice])
  @@index([bedrooms, bathrooms])
  @@index([deletedAt])
}

// ====================
// APPLICATIONS
// ====================

model Application {
  id                        String            @id @default(cuid())
  applicantId               String
  listingId                 String
  status                    ApplicationStatus @default(SUBMITTED)
  
  // Employment
  employmentStatus          String
  employerName              String?
  jobTitle                  String?
  monthlyIncome             Decimal           @db.Decimal(10, 2)
  employmentStartDate       DateTime?
  
  // Financial
  creditScore               Int?
  hasBankruptcy             Boolean           @default(false)
  hasEvictions              Boolean           @default(false)
  
  // Rental history
  currentAddress            String?
  currentLandlordName       String?
  currentLandlordPhone      String?
  currentRent               Decimal?          @db.Decimal(10, 2)
  moveInDate                DateTime?
  reasonForMoving           String?
  
  // Occupants
  numberOfOccupants         Int               @default(1)
  hasPets                   Boolean           @default(false)
  petDetails                String?
  
  // Screening
  backgroundCheckStatus     String?
  creditCheckStatus         String?
  incomeVerified            Boolean?
  employmentVerified        Boolean?
  landlordReferenceStatus   String?
  
  // Fair Chance Housing Act compliance
  criminalHistoryDeferred   Boolean           @default(true)
  criminalHistoryDisclosed  Boolean?
  individualAssessmentCompleted Boolean?
  individualAssessmentNotes String?
  
  // TheGuarantors
  guarantorRequired         Boolean?
  guarantorReferralSent     Boolean?
  guarantorReferralId       String?
  guarantorApproved         Boolean?
  
  // Fees
  applicationFee            Decimal           @db.Decimal(6, 2) @default(20)
  applicationFeePaidAt      DateTime?
  
  // Decision
  decisionNotes             String?
  decisionDate              DateTime?
  decisionBy                String?
  
  additionalNotes           String?
  
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  deletedAt                 DateTime?
  
  // Relations
  applicant                 User              @relation("ApplicantApplications", fields: [applicantId], references: [id])
  listing                   Listing           @relation(fields: [listingId], references: [id])
  lease                     Lease?
  coApplicants              User[]            @relation("CoApplicants")

  @@unique([applicantId, listingId])
  @@index([applicantId])
  @@index([listingId])
  @@index([status])
  @@index([deletedAt])
}

// ====================
// LEASES
// ====================

model Lease {
  id                    String        @id @default(cuid())
  listingId             String
  applicationId         String?       @unique
  tenantId              String
  landlordId            String
  agentId               String?
  
  status                LeaseStatus   @default(DRAFT)
  
  startDate             DateTime
  endDate               DateTime
  monthlyRent           Decimal       @db.Decimal(10, 2)
  securityDeposit       Decimal       @db.Decimal(10, 2)
  brokerFee             Decimal?      @db.Decimal(10, 2)
  moveInCosts           Json?
  
  terms                 String?
  specialConditions     String?
  
  // Signatures
  signedAt              DateTime?
  signedByTenant        DateTime?
  signedByLandlord      DateTime?
  
  // Renewal
  renewalDecision       String?
  renewalDecisionDate   DateTime?
  renewalDecisionBy     String?
  renewalNotes          String?
  notRenewingReason     String?
  
  // Notifications sent
  notification90DaySent DateTime?
  notification60DaySent DateTime?
  notification30DaySent DateTime?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  deletedAt             DateTime?
  
  // Relations
  listing               Listing       @relation(fields: [listingId], references: [id])
  application           Application?  @relation(fields: [applicationId], references: [id])
  tenant                User          @relation("TenantLeases", fields: [tenantId], references: [id])
  landlord              User          @relation("LandlordLeases", fields: [landlordId], references: [id])
  agent                 User?         @relation("AgentLeases", fields: [agentId], references: [id])
  payments              Payment[]
  feedback              AgentFeedback[]

  @@index([tenantId])
  @@index([landlordId])
  @@index([agentId])
  @@index([status])
  @@index([endDate])
  @@index([deletedAt])
}

// ====================
// PAYMENTS
// ====================

model Payment {
  id              String          @id @default(cuid())
  leaseId         String
  payerId         String
  
  type            PaymentType
  amount          Decimal         @db.Decimal(10, 2)
  status          PaymentStatus   @default(PENDING)
  
  dueDate         DateTime
  paidAt          DateTime?
  
  description     String?
  processorId     String?
  processorFee    Decimal?        @db.Decimal(8, 2)
  
  failureReason   String?
  refundedAt      DateTime?
  refundReason    String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?
  
  // Relations
  lease           Lease           @relation(fields: [leaseId], references: [id])
  payer           User            @relation(fields: [payerId], references: [id])

  @@index([leaseId])
  @@index([payerId])
  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
}

// ====================
// LEADS & TOURS
// ====================

model Lead {
  id                      String        @id @default(cuid())
  listingId               String?
  agentId                 String?
  
  status                  LeadStatus    @default(NEW)
  source                  String?
  
  // Contact info
  firstName               String
  lastName                String
  email                   String?
  phone                   String?
  preferredContactMethod  String?
  
  // Preferences
  propertyPreferences     Json?
  budget                  Decimal?      @db.Decimal(10, 2)
  moveInTimeline          String?
  
  // Tracking
  notes                   String?
  lastContactedAt         DateTime?
  nextFollowUpAt          DateTime?
  
  // Jeeva.ai integration
  jeevaLeadId             String?
  jeevaStatus             String?
  
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  deletedAt               DateTime?
  
  // Relations
  listing                 Listing?      @relation(fields: [listingId], references: [id])
  agent                   User?         @relation("AgentLeads", fields: [agentId], references: [id])
  tours                   Tour[]

  @@index([agentId])
  @@index([listingId])
  @@index([status])
  @@index([deletedAt])
}

model Tour {
  id                String        @id @default(cuid())
  listingId         String
  leadId            String?
  agentId           String?
  
  status            TourStatus    @default(SCHEDULED)
  
  scheduledAt       DateTime
  duration          Int           @default(30)
  
  // Access
  accessCode        String?
  accessCodeExpiry  DateTime?
  seamDeviceId      String?
  
  // Notes
  notes             String?
  feedback          String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  listing           Listing       @relation(fields: [listingId], references: [id])
  lead              Lead?         @relation(fields: [leadId], references: [id])
  agent             User?         @relation("AgentTours", fields: [agentId], references: [id])

  @@index([listingId])
  @@index([agentId])
  @@index([scheduledAt])
  @@index([status])
}

// ====================
// NOTIFICATIONS
// ====================

model Notification {
  id            String              @id @default(cuid())
  userId        String
  
  type          String
  channel       NotificationChannel
  
  subject       String?
  content       String
  data          Json?
  
  sentAt        DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  
  createdAt     DateTime            @default(now())
  
  // Relations
  user          User                @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ====================
// AGENT FEEDBACK
// ====================

model AgentFeedback {
  id                      String    @id @default(cuid())
  agentId                 String
  providerId              String
  leaseId                 String?
  listingId               String?
  applicationId           String?
  
  providerType            String    // TENANT or LANDLORD
  isAnonymous             Boolean   @default(false)
  
  category                String
  reasonCode              String
  rating                  Int
  
  strengths               String?
  areasForImprovement     String
  additionalComments      String?
  
  // Agent response
  acknowledgedAt          DateTime?
  agentResponse           String?
  improvementPlanCreated  Boolean   @default(false)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  agent                   User      @relation("AgentFeedback", fields: [agentId], references: [id])
  provider                User      @relation("FeedbackProvider", fields: [providerId], references: [id])
  lease                   Lease?    @relation(fields: [leaseId], references: [id])

  @@index([agentId])
  @@index([providerId])
  @@index([category])
  @@index([createdAt])
}

// ====================
// AUDIT LOG
// ====================

model AuditLog {
  id          String    @id @default(cuid())
  userId      String?
  action      String
  entityType  String
  entityId    String?
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}
